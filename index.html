<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Robot Dog">
    <title>ü§ñ Robot Dog Controller</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
        }
        
        .status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            margin-bottom: 20px;
            border: 2px solid #e9ecef;
        }
        
        .status.connected {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        
        .status.disconnected {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 30px 0;
        }
        
        .btn {
            border: none;
            border-radius: 15px;
            padding: 20px 10px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .btn:active {
            transform: scale(0.95);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        
        .btn-move {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .btn-stop {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .btn-action {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .btn-pattern {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .btn-connect {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            width: 100%;
            padding: 20px;
            font-size: 20px;
            margin-top: 20px;
        }
        
        .icon {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .action-row {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-row .btn {
            flex: 1;
        }
        
        .pattern-row {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .pattern-row .btn {
            flex: 1;
        }
        
        .device-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .device-item {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            cursor: pointer;
        }
        
        .device-item:hover {
            background: #e9ecef;
        }
        
        .device-item:last-child {
            border-bottom: none;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .btn {
                padding: 15px 5px;
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Robot Dog Controller</h1>
        
        <div id="status" class="status disconnected">
            üîå Tap Connect to Start
        </div>
        
        <div id="deviceList" class="device-list" style="display: none;">
            <!-- Devices will appear here -->
        </div>
        
        <div class="control-grid">
            <div></div>
            <button class="btn btn-move" onclick="sendCommand('F')">
                <div class="icon">‚¨ÜÔ∏è</div>
                <div>FORWARD</div>
            </button>
            <div></div>
            
            <button class="btn btn-move" onclick="sendCommand('L')">
                <div class="icon">‚¨ÖÔ∏è</div>
                <div>LEFT</div>
            </button>
            <button class="btn btn-stop" onclick="sendCommand('S')">
                <div class="icon">‚èπÔ∏è</div>
                <div>STOP</div>
            </button>
            <button class="btn btn-move" onclick="sendCommand('R')">
                <div class="icon">‚û°Ô∏è</div>
                <div>RIGHT</div>
            </button>
            
            <div></div>
            <button class="btn btn-move" onclick="sendCommand('B')">
                <div class="icon">‚¨áÔ∏è</div>
                <div>BACKWARD</div>
            </button>
            <div></div>
        </div>
        
        <div class="action-row">
            <button class="btn btn-action" onclick="sendCommand('H')">
                <div class="icon">üëã</div>
                <div>HELLO</div>
            </button>
            <button class="btn btn-action" onclick="sendCommand('T')">
                <div class="icon">üí™</div>
                <div>STRETCH</div>
            </button>
        </div>
        
        <div class="pattern-row">
            <button class="btn btn-pattern" onclick="startPattern()">
                <div class="icon">‚ñ∂Ô∏è</div>
                <div>PATTERN</div>
            </button>
            <button class="btn btn-stop" onclick="stopPattern()">
                <div class="icon">‚èπÔ∏è</div>
                <div>STOP</div>
            </button>
        </div>
        
        <button id="connectBtn" class="btn btn-connect" onclick="connectBluetooth()">
            üîó CONNECT BLUETOOTH
        </button>
        
        <div style="text-align: center; margin-top: 20px; color: #666; font-size: 14px;">
            <p>Add to Home Screen for best experience:</p>
            <p>üì± Safari ‚Üí Share ‚Üí Add to Home Screen</p>
        </div>
    </div>

    <script>
        let bluetoothDevice = null;
        let characteristic = null;
        let patternRunning = false;
        let patternStep = 0;
        let patternTimer = null;
        
        // Service UUID for HC-05/HC-06 (Standard Serial)
        const SERVICE_UUID = '00001101-0000-1000-8000-00805f9b34fb';
        const CHARACTERISTIC_UUID = '00001101-0000-1000-8000-00805f9b34fb';
        
        const statusDiv = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const deviceListDiv = document.getElementById('deviceList');
        
        async function connectBluetooth() {
            try {
                statusDiv.textContent = 'üîç Searching for devices...';
                statusDiv.className = 'status disconnected';
                
                // Request Bluetooth device
                bluetoothDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ name: ['HC-05', 'HC-06'] }],
                    optionalServices: [SERVICE_UUID]
                });
                
                statusDiv.textContent = 'üì° Connecting to ' + bluetoothDevice.name + '...';
                
                // Connect to GATT server
                const server = await bluetoothDevice.gatt.connect();
                
                // Get the service
                const service = await server.getPrimaryService(SERVICE_UUID);
                
                // Get the characteristic
                characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
                
                // Update UI
                statusDiv.textContent = '‚úÖ Connected to ' + bluetoothDevice.name;
                statusDiv.className = 'status connected';
                connectBtn.textContent = 'üì± CONNECTED';
                connectBtn.disabled = true;
                
                // Listen for disconnection
                bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
            } catch (error) {
                statusDiv.textContent = '‚ùå Error: ' + error.message;
                statusDiv.className = 'status disconnected';
                console.error('Bluetooth error:', error);
            }
        }
        
        function onDisconnected() {
            statusDiv.textContent = 'üîå Disconnected';
            statusDiv.className = 'status disconnected';
            connectBtn.textContent = 'üîó CONNECT BLUETOOTH';
            connectBtn.disabled = false;
            patternRunning = false;
        }
        
        async function sendCommand(command) {
            if (!characteristic) {
                statusDiv.textContent = '‚ö†Ô∏è Not connected to Bluetooth';
                return;
            }
            
            try {
                // Convert string to ArrayBuffer
                const encoder = new TextEncoder();
                const data = encoder.encode(command);
                
                // Send command
                await characteristic.writeValue(data);
                
                // Update status briefly
                const commands = {
                    'F': 'Moving Forward',
                    'B': 'Moving Backward',
                    'L': 'Turning Left',
                    'R': 'Turning Right',
                    'S': 'Stopped',
                    'H': 'Hello!',
                    'T': 'Stretching...',
                    'P': 'Starting Pattern'
                };
                
                if (commands[command]) {
                    statusDiv.textContent = 'üì§ ' + commands[command];
                    setTimeout(() => {
                        if (bluetoothDevice && bluetoothDevice.gatt.connected) {
                            statusDiv.textContent = '‚úÖ Connected to ' + bluetoothDevice.name;
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('Send error:', error);
                statusDiv.textContent = '‚ùå Send failed: ' + error.message;
            }
        }
        
        function startPattern() {
            if (!characteristic) {
                statusDiv.textContent = '‚ö†Ô∏è Not connected to Bluetooth';
                return;
            }
            
            patternRunning = true;
            patternStep = 0;
            patternTimer = Date.now();
            sendCommand('P');
            statusDiv.textContent = 'üîÑ Pattern Started: Step 1/8';
            runPattern();
        }
        
        function stopPattern() {
            patternRunning = false;
            sendCommand('S');
            statusDiv.textContent = '‚èπÔ∏è Pattern Stopped';
        }
        
        async function runPattern() {
            if (!patternRunning) return;
            
            const now = Date.now();
            const elapsed = now - patternTimer;
            
            switch(patternStep) {
                case 0: // Forward for 2 seconds
                    if (elapsed >= 2000) {
                        await sendCommand('R');
                        patternStep = 1;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Turning Right (2/8)';
                    }
                    break;
                    
                case 1: // Turn right for 1 second
                    if (elapsed >= 1000) {
                        await sendCommand('F');
                        patternStep = 2;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Forward (3/8)';
                    }
                    break;
                    
                case 2: // Forward for 2 seconds
                    if (elapsed >= 2000) {
                        await sendCommand('R');
                        patternStep = 3;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Turning Right (4/8)';
                    }
                    break;
                    
                case 3: // Turn right for 1 second
                    if (elapsed >= 1000) {
                        await sendCommand('F');
                        patternStep = 4;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Forward (5/8)';
                    }
                    break;
                    
                case 4: // Forward for 2 seconds
                    if (elapsed >= 2000) {
                        await sendCommand('R');
                        patternStep = 5;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Turning Right (6/8)';
                    }
                    break;
                    
                case 5: // Turn right for 1 second
                    if (elapsed >= 1000) {
                        await sendCommand('F');
                        patternStep = 6;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Forward (7/8)';
                    }
                    break;
                    
                case 6: // Forward for 2 seconds
                    if (elapsed >= 2000) {
                        await sendCommand('R');
                        patternStep = 7;
                        patternTimer = now;
                        statusDiv.textContent = 'üîÑ Pattern: Final Turn (8/8)';
                    }
                    break;
                    
                case 7: // Turn right for 1 second
                    if (elapsed >= 1000) {
                        patternRunning = false;
                        await sendCommand('S');
                        statusDiv.textContent = '‚úÖ Pattern Complete!';
                        return;
                    }
                    break;
            }
            
            // Continue pattern
            if (patternRunning) {
                setTimeout(runPattern, 100);
            }
        }
        
        // iOS-specific: Check if Web Bluetooth is supported
        if (!navigator.bluetooth) {
            statusDiv.innerHTML = '‚ùå Web Bluetooth not supported<br><small>Update to iOS 15+ and enable Bluetooth in Safari Settings</small>';
        }
        
        // Add to Home Screen instructions for iOS
        if (window.navigator.standalone) {
            document.body.style.paddingTop = '20px';
        }
    </script>
</body>
</html>

